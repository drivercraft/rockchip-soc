# Cru 模块整合重构

**日期**: 2025-12-31

## 重构目的

消除代码重复,将两个 `Cru` 实现整合为一个统一的实现。

## 问题

之前的代码结构存在重复:

### 1. `src/variants/rk3588/mod.rs`

包含一个旧的 `Cru` 实现:
- 简单的 PLL 读取 (`get_pll_rate()`)
- 基础的时钟配置验证
- 缺少 PLL 寄存器读取的完整功能

### 2. `src/variants/rk3588/cru/mod.rs`

包含新的 `Cru` 实现:
- 完整的 PLL 寄存器读取 (`read_pll_rate()`)
- PLL 频率验证 (`verify_pll_frequency()`)
- 详细的 u-boot 对比验证
- 支持所有 9 个 PLL

这导致:
- 代码重复
- 功能不一致
- 维护困难

## 重构方案

### 整合后的结构

```
src/variants/rk3588/
├── mod.rs          # 模块入口,重新导出 Cru
└── cru/
    ├── mod.rs      # Cru 完整实现 (唯一版本)
    ├── consts.rs   # 寄存器常量定义
    └── pll.rs      # PLL 配置和工具函数
```

### 修改内容

#### `src/variants/rk3588/mod.rs`

**之前**:
```rust
mod syscon;
mod cru;

// 常量定义
const MHZ: u64 = 1_000_000;
const OSC_HZ: u64 = 24 * MHZ;
// ... 更多常量

// 旧的 Cru 实现 (297 行)
pub struct Cru { ... }
impl Cru { ... }
```

**之后**:
```rust
mod syscon;
pub mod cru;

// 公开导出
pub use cru::Cru;
```

**变更说明**:
- ✅ 删除了所有常量定义 (已移至 `cru/consts.rs`)
- ✅ 删除了旧的 `Cru` 实现 (297 行)
- ✅ 保留 `cru` 模块并公开导出
- ✅ 重新导出 `Cru` 以保持 API 兼容性

#### `src/variants/rk3588/cru/mod.rs`

保持不变,包含完整的 `Cru` 实现:
- PLL 寄存器读取功能
- 频率计算和验证
- u-boot 配置对比
- 完整的单元测试 (28 个测试)

## 验证结果

### 编译测试

```bash
$ cargo build
   Finished `dev` profile [unoptimized + debuginfo] target(s) in 0.15s

$ cargo test --lib
   test result: ok. 28 passed; 0 failed
```

✅ 所有测试通过
✅ 无编译错误
✅ 仅保留预期的未使用警告 (dead code analysis)

### API 兼容性

**用户代码无需修改**:

```rust
// 之前
use rockchip_soc::rk3588::Cru;
let mut cru = Cru::new(base, sys_grf);
cru.init();

// 之后 (完全相同)
use rockchip_soc::rk3588::Cru;
let mut cru = Cru::new(base, sys_grf);
cru.init();
```

## 功能对比

| 功能 | 旧实现 (mod.rs) | 新实现 (cru/mod.rs) |
|------|-----------------|---------------------|
| PLL 频率读取 | ✅ 简单版 | ✅ 完整版 |
| PLL 参数提取 | ✅ p, m, s, k | ✅ p, m, s, k |
| PLL 模式检查 | ✅ 基础 | ✅ 完整 (SLOW/NORMAL/DEEP) |
| 时钟配置验证 | ✅ 基础 | ✅ 详细 u-boot 对比 |
| PPLL 特殊处理 | ❌ 无 | ✅ 有 (ID=8) |
| 小数分频支持 | ✅ 有 | ✅ 有 |
| 频率验证 | ❌ 无 | ✅ 有 (0.1% 容忍度) |
| Debug 输出 | ✅ 基础 | ✅ 详细 |
| 单元测试 | ❌ 无 | ✅ 28 个测试 |

## 设计原则遵循

### DRY (Don't Repeat Yourself)

- ✅ 消除了重复的 `Cru` 实现
- ✅ 统一的常量定义 (`cru/consts.rs`)
- ✅ 单一的 PLL 读取逻辑

### KISS (Keep It Simple, Stupid)

- ✅ 清晰的模块结构
- ✅ 单一的实现源点
- ✅ 简化的模块入口

### YAGNI (You Aren't Gonna Need It)

- ✅ 删除了不需要的旧实现
- ✅ 只保留功能完整的新实现

## 优势总结

1. **代码质量**: 消除重复,遵循 DRY 原则
2. **功能完整**: 统一使用功能更强大的实现
3. **易于维护**: 单一源点,修改只需一处
4. **API 稳定**: 用户代码无需任何修改
5. **测试覆盖**: 继承完整的 28 个单元测试

## 文件变更统计

| 文件 | 变更 | 说明 |
|------|------|------|
| `src/variants/rk3588/mod.rs` | -297 行 | 删除旧实现,简化为模块入口 |
| `src/variants/rk3588/cru/mod.rs` | 保持不变 | 作为唯一的 Cru 实现 |
| 总计 | -297 行 | 代码减少,质量提升 |

## 后续建议

1. ✅ 已完成: 代码整合
2. ✅ 已完成: 测试验证
3. ✅ 已完成: 文档更新
4. 建议: 可以考虑将 `cru` 模块的子模块也公开导出,如果外部需要访问 `consts` 或 `pll`

---
**版本**: 1.0
**状态**: ✅ 完成并验证
